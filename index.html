<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AeroTrack - Global & Nepal Flight Tracker</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet Maps CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        
        /* Custom Scrollbar for flight list */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Map Container */
        #map-container { height: 100vh; width: 100%; z-index: 0; }

        /* Plane Icon Rotation Transition */
        .plane-icon { transition: transform 1s linear; }

        /* Bottom Sheet Animation */
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Pulse Animation for Live Status */
        .pulse-ring {
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            background-color: rgba(34, 197, 94, 0.5);
        }
        @keyframes pulse-ring { 0% { transform: scale(0.5); opacity: 0; } 50% { opacity: 1; } 100% { transform: scale(1.2); opacity: 0; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- MOCK DATA GENERATOR (Simulating an API) ---
        const AIRLINES = [
            { code: 'RA', name: 'Nepal Airlines', color: '#E11D23', type: 'Intl/Dom' },
            { code: 'U4', name: 'Buddha Air', color: '#1A3C87', type: 'Dom' },
            { code: 'YT', name: 'Yeti Airlines', color: '#F7941D', type: 'Dom' },
            { code: 'QR', name: 'Qatar Airways', color: '#5C0632', type: 'Intl' },
            { code: 'FZ', name: 'FlyDubai', color: '#FBAE17', type: 'Intl' },
            { code: 'TK', name: 'Turkish Airlines', color: '#C8102E', type: 'Intl' }
        ];

        const AIRPORTS = [
            { code: 'KTM', name: 'Tribhuvan Intl', lat: 27.6966, lng: 85.3591, city: 'Kathmandu' },
            { code: 'PKR', name: 'Pokhara Intl', lat: 28.1837, lng: 84.0328, city: 'Pokhara' },
            { code: 'BWA', name: 'Gautam Buddha', lat: 27.5064, lng: 83.4214, city: 'Bhairahawa' },
            { code: 'LUA', name: 'Tenzing-Hillary', lat: 27.6878, lng: 86.7314, city: 'Lukla' },
            { code: 'DXB', name: 'Dubai Intl', lat: 25.2532, lng: 55.3657, city: 'Dubai' },
            { code: 'DOH', name: 'Hamad Intl', lat: 25.2731, lng: 51.6081, city: 'Doha' },
            { code: 'DEL', name: 'Indira Gandhi', lat: 28.5562, lng: 77.1000, city: 'New Delhi' }
        ];

        // Generate random flights
        const generateFlights = () => {
            const flights = [];
            for (let i = 0; i < 15; i++) {
                const airline = AIRLINES[Math.floor(Math.random() * AIRLINES.length)];
                const dep = AIRPORTS[Math.floor(Math.random() * AIRPORTS.length)];
                let arr = AIRPORTS[Math.floor(Math.random() * AIRPORTS.length)];
                while(arr.code === dep.code) arr = AIRPORTS[Math.floor(Math.random() * AIRPORTS.length)];

                // Calculate progress (0 to 1)
                const progress = Math.random();
                const lat = dep.lat + (arr.lat - dep.lat) * progress;
                const lng = dep.lng + (arr.lng - dep.lng) * progress;
                const bearing = Math.atan2(arr.lng - dep.lng, arr.lat - dep.lat) * 180 / Math.PI;

                flights.push({
                    id: `FL-${1000 + i}`,
                    callsign: `${airline.code}${Math.floor(Math.random() * 900) + 100}`,
                    airline: airline,
                    dep: dep,
                    arr: arr,
                    lat: lat,
                    lng: lng,
                    alt: 25000 + Math.floor(Math.random() * 10000),
                    spd: 400 + Math.floor(Math.random() * 100),
                    heading: bearing,
                    status: progress > 0.9 ? 'Landed' : (progress < 0.1 ? 'Scheduled' : 'Flying'),
                    progress: progress
                });
            }
            return flights;
        };

        // --- COMPONENTS ---

        const FlightCard = ({ flight, onClick, compact = false }) => (
            <div 
                onClick={() => onClick(flight)}
                className={`bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 active:scale-95 transition-transform cursor-pointer ${compact ? 'mx-2 w-64 flex-shrink-0' : ''}`}
            >
                <div className="flex justify-between items-center mb-2">
                    <div className="flex items-center gap-2">
                        <span className="font-bold text-blue-900">{flight.callsign}</span>
                        <span className="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 font-medium">
                            {flight.airline.name}
                        </span>
                    </div>
                    <div className={`text-xs font-bold px-2 py-1 rounded ${
                        flight.status === 'Flying' ? 'bg-green-100 text-green-700' : 
                        flight.status === 'Landed' ? 'bg-blue-100 text-blue-700' : 'bg-yellow-100 text-yellow-700'
                    }`}>
                        {flight.status === 'Flying' ? 'LIVE' : flight.status}
                    </div>
                </div>
                <div className="flex justify-between items-center text-sm">
                    <div className="text-center w-1/3">
                        <div className="text-2xl font-bold text-gray-800">{flight.dep.code}</div>
                        <div className="text-xs text-gray-500 truncate">{flight.dep.city}</div>
                    </div>
                    <div className="flex-1 flex flex-col items-center px-2">
                        <i className="fa-solid fa-plane text-gray-300 text-lg transform rotate-90"></i>
                        <div className="w-full h-0.5 bg-gray-200 mt-1 relative">
                            <div className="absolute h-0.5 bg-blue-500 transition-all duration-1000" style={{width: `${flight.progress * 100}%`}}></div>
                        </div>
                    </div>
                    <div className="text-center w-1/3">
                        <div className="text-2xl font-bold text-gray-800">{flight.arr.code}</div>
                        <div className="text-xs text-gray-500 truncate">{flight.arr.city}</div>
                    </div>
                </div>
            </div>
        );

        const BottomSheet = ({ flight, onClose }) => {
            if (!flight) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-black/20 pointer-events-auto" onClick={onClose}></div>
                    <div className="bg-white w-full max-w-md rounded-t-3xl shadow-2xl p-6 pointer-events-auto slide-up pb-10">
                        
                        {/* Handle bar */}
                        <div className="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6"></div>

                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900">{flight.callsign}</h2>
                                <p className="text-gray-500">{flight.airline.name}</p>
                            </div>
                            <img 
                                src={`https://ui-avatars.com/api/?name=${flight.airline.name}&background=random&color=fff&size=48`} 
                                className="w-12 h-12 rounded-full border-2 border-white shadow-md"
                                alt="Logo"
                            />
                        </div>

                        <div className="flex justify-between items-center bg-gray-50 rounded-2xl p-4 mb-6">
                            <div className="text-center">
                                <div className="text-3xl font-black text-gray-800">{flight.dep.code}</div>
                                <div className="text-sm text-gray-500">{flight.dep.city}</div>
                                <div className="text-xs font-mono text-gray-400 mt-1">10:45 AM</div>
                            </div>
                            <div className="flex flex-col items-center">
                                <span className="text-xs text-blue-600 font-bold mb-1">
                                    {Math.round((1-flight.progress)*100)} min left
                                </span>
                                <i className="fa-solid fa-plane text-blue-500 text-xl transform rotate-90"></i>
                            </div>
                            <div className="text-center">
                                <div className="text-3xl font-black text-gray-800">{flight.arr.code}</div>
                                <div className="text-sm text-gray-500">{flight.arr.city}</div>
                                <div className="text-xs font-mono text-gray-400 mt-1">11:55 AM</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-4 mb-6">
                            <div className="bg-gray-50 p-3 rounded-xl text-center">
                                <div className="text-gray-400 text-xs uppercase font-bold mb-1">Altitude</div>
                                <div className="font-bold text-gray-800">{flight.alt} ft</div>
                            </div>
                            <div className="bg-gray-50 p-3 rounded-xl text-center">
                                <div className="text-gray-400 text-xs uppercase font-bold mb-1">Speed</div>
                                <div className="font-bold text-gray-800">{flight.spd} kts</div>
                            </div>
                            <div className="bg-gray-50 p-3 rounded-xl text-center">
                                <div className="text-gray-400 text-xs uppercase font-bold mb-1">Aircraft</div>
                                <div className="font-bold text-gray-800">A320</div>
                            </div>
                        </div>

                        <button onClick={onClose} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition active:scale-95">
                            Track on Map
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [flights, setFlights] = useState([]);
            const [selectedFlight, setSelectedFlight] = useState(null);
            const [view, setView] = useState('map'); // 'map' or 'list'
            const [searchTerm, setSearchTerm] = useState('');
            const mapRef = useRef(null);
            const markersRef = useRef({});

            // Initialize Data
            useEffect(() => {
                const initialFlights = generateFlights();
                setFlights(initialFlights);

                // Simulate Real-time Movement Loop
                const interval = setInterval(() => {
                    setFlights(prevFlights => 
                        prevFlights.map(f => {
                            if (f.status !== 'Flying') return f;
                            
                            // Move flight slightly towards destination
                            const step = 0.005; 
                            const newLat = f.lat + (f.arr.lat - f.dep.lat) * step;
                            const newLng = f.lng + (f.arr.lng - f.dep.lng) * step;
                            const newProgress = f.progress + step;

                            return {
                                ...f,
                                lat: newLat,
                                lng: newLng,
                                progress: newProgress,
                                status: newProgress >= 1 ? 'Landed' : 'Flying'
                            };
                        })
                    );
                }, 1000);

                return () => clearInterval(interval);
            }, []);

            // Initialize Map
            useEffect(() => {
                if (!mapRef.current) {
                    // Center on Nepal
                    mapRef.current = L.map('map-container', { zoomControl: false }).setView([28.3949, 84.1240], 7);
                    
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }).addTo(mapRef.current);
                }
            }, []);

            // Update Map Markers
            useEffect(() => {
                if (!mapRef.current) return;

                const map = mapRef.current;

                // Clear old markers that aren't in current flight list (optional optimization)
                
                flights.forEach(flight => {
                    if (flight.status !== 'Flying') return;

                    const iconHtml = `
                        <div style="transform: rotate(${flight.heading - 90}deg); transition: all 1s linear;">
                            <i class="fa-solid fa-plane text-blue-600 text-2xl drop-shadow-md"></i>
                        </div>
                    `;
                    
                    const customIcon = L.divIcon({
                        html: iconHtml,
                        className: 'bg-transparent',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    if (markersRef.current[flight.id]) {
                        // Update position
                        markersRef.current[flight.id].setLatLng([flight.lat, flight.lng]);
                        markersRef.current[flight.id].setIcon(customIcon);
                    } else {
                        // Create new marker
                        const marker = L.marker([flight.lat, flight.lng], { icon: customIcon })
                            .addTo(map)
                            .on('click', () => setSelectedFlight(flight));
                        
                        markersRef.current[flight.id] = marker;
                    }
                });
            }, [flights]);

            const filteredFlights = flights.filter(f => 
                f.callsign.toLowerCase().includes(searchTerm.toLowerCase()) ||
                f.dep.city.toLowerCase().includes(searchTerm.toLowerCase()) ||
                f.arr.city.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const activeFlightsCount = flights.filter(f => f.status === 'Flying').length;

            return (
                <div className="h-screen w-full relative flex flex-col">
                    
                    {/* Top Search Bar (Floating) */}
                    <div className="absolute top-0 left-0 right-0 z-[1000] p-4 pointer-events-none">
                        <div className="bg-white/90 backdrop-blur-md shadow-lg rounded-2xl flex items-center p-3 pointer-events-auto max-w-md mx-auto">
                            <i className="fa-solid fa-search text-gray-400 ml-2"></i>
                            <input 
                                type="text" 
                                placeholder="Search flight, city, or airline..." 
                                className="bg-transparent border-none outline-none flex-1 px-3 text-gray-700 placeholder-gray-400"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                            {searchTerm && (
                                <button onClick={() => setSearchTerm('')} className="text-gray-400 hover:text-gray-600">
                                    <i className="fa-solid fa-times"></i>
                                </button>
                            )}
                        </div>
                        
                        {/* Search Results Dropdown */}
                        {searchTerm && (
                            <div className="bg-white mt-2 rounded-xl shadow-xl max-w-md mx-auto max-h-60 overflow-y-auto pointer-events-auto">
                                {filteredFlights.map(f => (
                                    <div key={f.id} onClick={() => {
                                        setSelectedFlight(f);
                                        setSearchTerm('');
                                        if (mapRef.current && f.status === 'Flying') {
                                            mapRef.current.flyTo([f.lat, f.lng], 9);
                                        }
                                    }} className="p-3 border-b border-gray-100 flex justify-between items-center hover:bg-gray-50">
                                        <div>
                                            <div className="font-bold text-blue-900">{f.callsign}</div>
                                            <div className="text-xs text-gray-500">{f.dep.city} to {f.arr.city}</div>
                                        </div>
                                        <div className="text-xs font-bold text-gray-400">{f.status}</div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Main Content Area */}
                    <div className="flex-1 relative bg-gray-100">
                        
                        {/* MAP VIEW */}
                        <div id="map-container" className={`${view === 'map' ? 'block' : 'hidden'}`}></div>
                        
                        {/* Map Overlay Stats */}
                        {view === 'map' && (
                            <div className="absolute top-20 right-4 z-[999]">
                                <div className="bg-white/90 backdrop-blur rounded-lg shadow-lg p-2 text-center">
                                    <div className="text-xs text-gray-500 uppercase font-bold">In Air</div>
                                    <div className="text-xl font-black text-green-600">{activeFlightsCount}</div>
                                </div>
                            </div>
                        )}

                        {/* LIST VIEW */}
                        {view === 'list' && (
                            <div className="h-full overflow-y-auto p-4 pt-24 pb-24 max-w-md mx-auto">
                                <h2 className="text-xl font-bold text-gray-800 mb-4 px-1">Active Schedule</h2>
                                
                                <div className="space-y-4">
                                    {/* Tabs */}
                                    <div className="flex gap-2 mb-4 overflow-x-auto hide-scroll pb-2">
                                        <button className="px-4 py-2 bg-blue-600 text-white rounded-full text-sm font-bold shadow-md whitespace-nowrap">All Flights</button>
                                        <button className="px-4 py-2 bg-white text-gray-600 rounded-full text-sm font-bold shadow-sm whitespace-nowrap">Nepalese</button>
                                        <button className="px-4 py-2 bg-white text-gray-600 rounded-full text-sm font-bold shadow-sm whitespace-nowrap">International</button>
                                    </div>

                                    {filteredFlights.length === 0 ? (
                                        <div className="text-center text-gray-400 mt-10">
                                            <i className="fa-solid fa-plane-slash text-4xl mb-2"></i>
                                            <p>No flights found.</p>
                                        </div>
                                    ) : (
                                        filteredFlights.map(flight => (
                                            <FlightCard key={flight.id} flight={flight} onClick={setSelectedFlight} />
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Bottom Navigation */}
                    <div className="bg-white border-t border-gray-200 safe-area-pb z-[1001]">
                        <div className="flex justify-around items-center h-16 max-w-md mx-auto">
                            <button 
                                onClick={() => setView('map')}
                                className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${view === 'map' ? 'text-blue-600' : 'text-gray-400'}`}
                            >
                                <i className="fa-solid fa-map text-xl"></i>
                                <span className="text-[10px] font-bold">Radar</span>
                            </button>
                            
                            <div className="relative -top-6">
                                <button className="bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center border-4 border-gray-100 hover:bg-blue-700 transition">
                                    <i className="fa-solid fa-plane-departure text-xl"></i>
                                </button>
                            </div>

                            <button 
                                onClick={() => setView('list')}
                                className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${view === 'list' ? 'text-blue-600' : 'text-gray-400'}`}
                            >
                                <i className="fa-solid fa-list text-xl"></i>
                                <span className="text-[10px] font-bold">Schedule</span>
                            </button>
                        </div>
                    </div>

                    {/* Detailed Flight View (Bottom Sheet) */}
                    <BottomSheet flight={selectedFlight} onClose={() => setSelectedFlight(null)} />

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>